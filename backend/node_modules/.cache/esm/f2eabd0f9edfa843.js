let fs,express,swaggerUi,cors,InputError,AccessError,BACKEND_PORT,swaggerDocument,save,getUserIdFromAuthorization,login,register,getUserIdFromEmail,assertValidUserId,assertValidJobPost,assertCreatorOfJobPost,assertWatcherOfJobPost,getUser,watchUser,updateProfile,getJobs,postJob,updateJobPost,commentOnJobPost,likeJobPost,deleteJobPost;_9ed‍.x([["default",()=>_9ed‍.o]]);_9ed‍.w("fs",[["default",["fs"],function(v){fs=v}]]);_9ed‍.w("express",[["default",["express"],function(v){express=v}]]);_9ed‍.w("swagger-ui-express",[["default",["swaggerUi"],function(v){swaggerUi=v}]]);_9ed‍.w("cors",[["default",["cors"],function(v){cors=v}]]);_9ed‍.w("./error",[["InputError",["InputError"],function(v){InputError=v}],["AccessError",["AccessError"],function(v){AccessError=v}]]);_9ed‍.w("../../frontend/src/config",[["BACKEND_PORT",["BACKEND_PORT"],function(v){BACKEND_PORT=v}]]);_9ed‍.w("../swagger.json",[["default",["swaggerDocument"],function(v){swaggerDocument=v}]]);_9ed‍.w("./service",[["save",["save"],function(v){save=v}],["getUserIdFromAuthorization",["getUserIdFromAuthorization"],function(v){getUserIdFromAuthorization=v}],["login",["login"],function(v){login=v}],["register",["register"],function(v){register=v}],["getUserIdFromEmail",["getUserIdFromEmail"],function(v){getUserIdFromEmail=v}],["assertValidUserId",["assertValidUserId"],function(v){assertValidUserId=v}],["assertValidJobPost",["assertValidJobPost"],function(v){assertValidJobPost=v}],["assertCreatorOfJobPost",["assertCreatorOfJobPost"],function(v){assertCreatorOfJobPost=v}],["assertWatcherOfJobPost",["assertWatcherOfJobPost"],function(v){assertWatcherOfJobPost=v}],["getUser",["getUser"],function(v){getUser=v}],["watchUser",["watchUser"],function(v){watchUser=v}],["updateProfile",["updateProfile"],function(v){updateProfile=v}],["getJobs",["getJobs"],function(v){getJobs=v}],["postJob",["postJob"],function(v){postJob=v}],["updateJobPost",["updateJobPost"],function(v){updateJobPost=v}],["commentOnJobPost",["commentOnJobPost"],function(v){commentOnJobPost=v}],["likeJobPost",["likeJobPost"],function(v){likeJobPost=v}],["deleteJobPost",["deleteJobPost"],function(v){deleteJobPost=v}]]);




























const app = express();

app.use(cors());
app.use(express.urlencoded({ extended: true, }));
app.use(express.json({ limit: '50mb', }));

const catchErrors = fn => async (req, res) => {
  try {
    await fn(req, res);
    save();
  } catch (err) {
    if (err instanceof InputError) {
      res.status(400).send({ error: err.message, });
    } else if (err instanceof AccessError) {
      res.status(403).send({ error: err.message, });
    } else {
      _9ed‍.g.console.log(err);
      res.status(500).send({ error: 'A system error ocurred', });
    }
  }
};

/***************************************************************
                         Auth Functions
***************************************************************/

const authed = fn => async (req, res) => {
  const userId = getUserIdFromAuthorization(req.header('Authorization'));
  await fn(req, res, userId);
};

app.post('/auth/login', catchErrors(async (req, res) => {
  const { email, password, } = req.body;
  return res.json(await login(email, password));
}));

app.post('/auth/register', catchErrors(async (req, res) => {
  const { email, password, name, } = req.body;
  return res.json(await register(email, password, name));
}));

/***************************************************************
                        Job Functions
***************************************************************/

app.get('/job/feed', catchErrors(authed(async (req, res, authUserId) => {
  const { start, } = req.query;
  return res.json(await getJobs(authUserId, parseInt(start, 10)));
})));

app.post('/job', catchErrors(authed(async (req, res, authUserId) => {
  const { image, title, start, description } = req.body;
  return res.json({
    id: await postJob(authUserId, image, title, start, description),
  });
})));

app.put('/job', catchErrors(authed(async (req, res, authUserId) => {
  const { id, image, title, start, description } = req.body;
  await assertValidJobPost(id);
  await assertCreatorOfJobPost(authUserId, id);
  await updateJobPost(authUserId, id, image, title, start, description);
  return res.status(200).send({});
})));

app.delete('/job', catchErrors(authed(async (req, res, authUserId) => {
  const { id, } = req.body;
  await assertValidJobPost(id);
  await assertCreatorOfJobPost(authUserId, id);
  await deleteJobPost(authUserId, id);
  return res.status(200).send({});
})));

app.post('/job/comment', catchErrors(authed(async (req, res, authUserId) => {
  const { id, comment, } = req.body;
  await assertValidJobPost(id);
  await assertWatcherOfJobPost(authUserId, id);
  await commentOnJobPost(authUserId, id, comment);
  return res.status(200).send({});
})));

app.put('/job/like', catchErrors(authed(async (req, res, authUserId) => {
  const { id, turnon } = req.body;
  await assertValidJobPost(id);
  await assertWatcherOfJobPost(authUserId, id);
  await likeJobPost(authUserId, id, turnon);
  return res.status(200).send({});
})));



/***************************************************************
                        User Functions
***************************************************************/

app.get('/user', catchErrors(authed(async (req, res, authUserId) => {
  const { userId, } = req.query;
  await assertValidUserId(userId);
  return res.json(await getUser(userId));
})));

app.put('/user/watch', catchErrors(authed(async (req, res, authUserId) => {
  const { email, id, turnon } = req.body;
  let userId = id;
  if (id === undefined) {
    userId = getUserIdFromEmail(email);
  }
  await assertValidUserId(userId);
  await watchUser(authUserId, userId, turnon);
  return res.status(200).send({});
})));

app.put('/user', catchErrors(authed(async (req, res, authUserId) => {
  const { email, password, name, image } = req.body;
  await updateProfile(authUserId, email, password, name, image);
  return res.status(200).send({});
})));

/***************************************************************
                       Running Server
***************************************************************/

app.get('/', (req, res) => res.redirect('/docs'));

app.use('/docs', swaggerUi.serve, swaggerUi.setup(swaggerDocument));


const port = BACKEND_PORT || 5000;

const server = app.listen(port, () => {
  console.log(`Backend is now listening on port ${port}!`);
  console.log(`For API docs, navigate to http://localhost:${port}`);
});

_9ed‍.d(server);
